<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Card V20</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root { --bg: #EAF3F7; --card: #fff; --text: #334155; --sub: #64748b; --accent: #3a7bd5; --danger: #ff4757; }
        body.dark { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --sub: #94a3b8; }
        body { background: var(--bg); font-family: system-ui, sans-serif; color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; transition: 0.5s; }
        
        .toolbar, .visitor-nav { position: absolute; top: 20px; z-index: 100; display: flex; gap: 10px; }
        .toolbar { right: 20px; } .visitor-nav { left: 20px; display: none; }
        .btn { background: rgba(255,255,255,0.2); border: 1px solid #cbd5e1; color: var(--text); padding: 8px 15px; border-radius: 20px; cursor: pointer; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 5px; font-size: 13px; transition: 0.3s; }
        .btn:hover { background: rgba(255,255,255,0.6); transform: translateY(-2px); }
        body.dark .btn { border-color: #475569; background: rgba(255,255,255,0.1); }
        .btn-red { color: var(--danger); border-color: var(--danger); } .btn-red:hover { background: var(--danger); color: #fff; }
        
        .card { background: var(--card); width: 100%; max-width: 340px; padding: 40px 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.08); position: relative; }
        .avatar { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 4px solid var(--card); box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 15px; cursor: pointer; transition: 0.5s; }
        .avatar:hover { transform: rotate(360deg); }
        
        [contenteditable="true"]:focus { outline: none; border-bottom: 2px solid var(--accent); background: rgba(58,123,213,0.05); }
        h1 { margin: 10px 0; font-size: 24px; } .role { color: var(--sub); font-size: 13px; margin-bottom: 30px; }
        .list { text-align: left; }
        .item { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; border-radius: 12px; }
        body:not(.read) .item:hover { background: rgba(0,0,0,0.03); }
        .item i { font-size: 20px; color: var(--sub); margin-right: 15px; cursor: pointer; }
        .txt { font-size: 14px; flex: 1; outline: none; word-break: break-all; }
        
        /* å¼¹çª— */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 999; display: none; justify-content: center; align-items: center; }
        .box { background: var(--card); padding: 30px; border-radius: 20px; width: 300px; text-align: center; }
        .inp { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; background: transparent; color: var(--text); }
        .btn-sub { width: 100%; padding: 10px; background: var(--accent); color: #fff; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        
        /* çŠ¶æ€æŒ‡ç¤º */
        #status { position: fixed; bottom: 20px; right: 20px; font-size: 12px; color: var(--sub); opacity: 0; transition: 0.3s; }
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: var(--text); }
        
        /* ç®¡ç†é¢æ¿ */
        #admin { position: fixed; inset: 20px; background: var(--card); z-index: 1500; border-radius: 20px; padding: 20px; display: none; flex-direction: column; box-shadow: 0 50px 100px rgba(0,0,0,0.3); }
        .tbl-wrap { flex: 1; overflow: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        
        .read .avatar, .read i { pointer-events: none; }
    </style>
</head>
<body>

    <div id="loader"><h2 id="load-txt">æ­£åœ¨åŠ è½½...</h2><p id="load-err" style="color:red;font-size:12px"></p></div>
    <div id="status"></div>
    <input type="file" id="file" hidden accept="image/*" onchange="uploadImg(event)">

    <div id="modal"><div class="box"><h3 id="m-title">ç™»å½•</h3><input id="u" class="inp" placeholder="ç”¨æˆ·å"><input id="p" type="password" class="inp" placeholder="å¯†ç "><button class="btn-sub" onclick="auth()">ç¡®å®š</button><div style="margin-top:10px;font-size:12px;cursor:pointer" onclick="flip()" id="m-tip">å»æ³¨å†Œ</div><button onclick="closeM()" style="margin-top:10px;background:none;border:none;color:#999">å…³é—­</button></div></div>

    <div id="admin">
        <div style="display:flex;justify-content:space-between;margin-bottom:10px"><h3>ç”¨æˆ·ç®¡ç†</h3><button onclick="toggleAdmin(0)">å…³é—­</button></div>
        <div class="tbl-wrap"><table id="tbl"><thead><tr><th>ç”¨æˆ·</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="toolbar" id="tb-edit">
        <button class="btn" id="btn-login" onclick="openM()"><i class="ri-user-line"></i> ç™»å½•</button>
        <button class="btn" id="btn-admin" onclick="loadAdmin()" style="display:none;color:#8e44ad;border-color:#8e44ad"><i class="ri-settings-4-line"></i> ç®¡ç†</button>
        <button class="btn btn-red" id="btn-out" onclick="logout()" style="display:none"><i class="ri-logout-box-line"></i> é€€å‡º</button>
        <button class="btn" id="btn-share" onclick="share()" style="display:none"><i class="ri-share-forward-line"></i> é“¾æ¥</button>
        <button class="btn" onclick="mode()"><i class="ri-moon-line"></i></button>
    </div>

    <div class="visitor-nav" id="tb-read">
        <button class="btn" onclick="goHome()"><i class="ri-arrow-left-line"></i> ä¸»é¡µ</button>
        <button class="btn" onclick="mode()"><i class="ri-contrast-line"></i></button>
    </div>

    <div class="card" oninput="debounceSave()">
        <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" class="avatar" id="av" onclick="clickAv()">
        <h1 id="name" contenteditable="true">ä½ çš„åå­—</h1>
        <div id="role" class="role" contenteditable="true">ä¸€å¥è¯ä»‹ç»è‡ªå·±</div>
        <div class="list">
            <div class="item"><i class="ri-global-line" id="i1" onclick="ic(this)"></i><div id="t1" class="txt" contenteditable="true">ä¸ªäººç½‘ç«™</div></div>
            <div class="item"><i class="ri-mail-send-line" id="i2" onclick="ic(this)"></i><div id="t2" class="txt" contenteditable="true">ç”µå­é‚®ç®±</div></div>
            <div class="item"><i class="ri-map-pin-line" id="i3" onclick="ic(this)"></i><div id="t3" class="txt" contenteditable="true">æ‰€åœ¨åŸå¸‚</div></div>
        </div>
    </div>

    <script>
        const ADMIN_NAME = 'admin'; // âš ï¸ å¿…é¡»ä¸ç¯å¢ƒå˜é‡ ADMIN_USER ä¸€è‡´
        let isReg = false, timer = null;

        window.onload = () => {
            // è§£æè·¯ç”±ï¼šå»é™¤æœ«å°¾æ–œæ ï¼Œæå–ç”¨æˆ·å
            let path = window.location.pathname.replace(/\/$/, "").substring(1);
            
            if (path && path !== 'index.html') {
                // è¿›å…¥è®¿å®¢æ¨¡å¼
                loadCloud(decodeURIComponent(path));
            } else {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼
                checkLog();
            }
        };

        // --- æ ¸å¿ƒï¼šäº‘ç«¯åŠ è½½ (å¸¦è¯¦ç»†æŠ¥é”™) ---
        async function loadCloud(user) {
            const l = document.getElementById('loader');
            const errTxt = document.getElementById('load-err');
            l.style.display = 'flex';
            
            // åˆ‡æ¢åˆ°è®¿å®¢UI
            document.getElementById('tb-edit').style.display = 'none';
            document.getElementById('tb-read').style.display = 'flex';
            document.body.classList.add('read');
            document.querySelectorAll('[contenteditable]').forEach(e => e.setAttribute('contenteditable', 'false'));

            try {
                const res = await fetch(`/api/user?name=${user}`);
                if (res.ok) {
                    const json = await res.json();
                    if(json.status === 'banned') {
                        l.innerHTML = '<h1>ğŸš« å·²è¢«å°ç¦</h1>';
                    } else {
                        fill(json.data);
                        l.style.display = 'none';
                    }
                } else {
                    if(res.status === 404) l.innerHTML = `<h1>ğŸ¤·â€â™‚ï¸ ç”¨æˆ·ä¸å­˜åœ¨</h1><br><a href="/">å»åˆ›å»º</a>`;
                    else l.innerHTML = `<h1>âŒ æœåŠ¡å™¨é”™è¯¯ (${res.status})</h1>`;
                }
            } catch (e) {
                l.innerHTML = `<h1>âš ï¸ ç½‘ç»œæ— æ³•è¿æ¥</h1>`;
                errTxt.innerText = "å¯èƒ½åŸå› ï¼š_redirects æ–‡ä»¶ç¼ºå¤± æˆ– åç«¯ API æœªéƒ¨ç½²";
            }
        }

        // --- æ ¸å¿ƒï¼šä¿å­˜æ•°æ® ---
        async function save(silent = false) {
            if (localStorage.getItem('login') !== '1') return;
            const u = localStorage.getItem('u');
            const p = localStorage.getItem('p');
            if(!silent) toast('æ­£åœ¨ä¿å­˜...');
            
            const data = {
                name: text('name'), role: text('role'), av: src('av'),
                t1: text('t1'), i1: cls('i1'),
                t2: text('t2'), i2: cls('i2'),
                t3: text('t3'), i3: cls('i3'),
                _p: p // å­˜å¯†ç ä»¥ä¾¿è·¨è®¾å¤‡éªŒè¯
            };

            try {
                const res = await fetch('/api/user', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: u, password: p, data: data })
                });
                if(res.ok) {
                    if(!silent) toast('âœ… å·²ä¿å­˜');
                    showStatus('å·²åŒæ­¥');
                } else {
                    showStatus('âŒ ä¿å­˜å¤±è´¥');
                }
            } catch(e) { showStatus('âš ï¸ ç½‘ç»œé”™è¯¯'); }
        }

        // --- è®¤è¯ ---
        async function auth() {
            const u = val('u'), p = val('p');
            if(!u || !p) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');
            
            if(isReg) {
                const res = await fetch(`/api/user?name=${u}`);
                if(res.ok) return alert('ç”¨æˆ·å·²å­˜åœ¨');
                localStorage.setItem('temp_p', p); // ä¸´æ—¶å­˜
                toast('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                flip();
            } else {
                // ç™»å½•éªŒè¯
                try {
                    const res = await fetch(`/api/user?name=${u}`);
                    if(res.ok) {
                        const json = await res.json();
                        // éªŒè¯å¯†ç  (äº‘ç«¯ _p æˆ– æœ¬åœ° temp_p)
                        const cloudP = json.data ? json.data._p : null;
                        const localP = localStorage.getItem('temp_p');
                        
                        if(cloudP === p || localP === p) {
                            success(u, p, json.data);
                        } else { alert('å¯†ç é”™è¯¯'); }
                    } else {
                        // å¦‚æœäº‘ç«¯æ²¡æ•°æ®ï¼Œä½†ä½ æ˜¯ç¬¬ä¸€æ¬¡æœ¬åœ°ç™»å½•(åˆšæ³¨å†Œå®Œæ²¡ä¿å­˜è¿‡)
                        if(localStorage.getItem('temp_p') === p) success(u, p, null);
                        else alert('ç”¨æˆ·ä¸å­˜åœ¨');
                    }
                } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
            }
        }

        function success(u, p, data) {
            localStorage.setItem('login', '1');
            localStorage.setItem('u', u);
            localStorage.setItem('p', p);
            if(data) fill(data);
            checkLog();
            closeM();
            toast('æ¬¢è¿å›æ¥');
        }

        // --- ç®¡ç†å‘˜ ---
        async function loadAdmin() {
            toggleAdmin(1);
            const t = document.getElementById('tbl').querySelector('tbody');
            t.innerHTML = '<tr><td>åŠ è½½ä¸­...</td></tr>';
            const u = localStorage.getItem('u'), p = localStorage.getItem('p');
            
            const res = await fetch('/api/admin', { headers: { 'X-Admin-Name': u, 'X-Admin-Pass': p } });
            if(res.status===401) return alert('æƒé™éªŒè¯å¤±è´¥');
            const list = await res.json();
            
            t.innerHTML = list.map(x => `
                <tr>
                    <td>${x.name} <span style="font-size:10px;color:#999">${x.role}</span></td>
                    <td>${x.status==='banned'?'ğŸš«':'âœ…'}</td>
                    <td>
                        ${x.name !== u ? `
                        <button onclick="act('ban','${x.name}')" style="color:orange">ç¦</button>
                        <button onclick="act('unban','${x.name}')" style="color:green">è§£</button>
                        <button onclick="act('delete','${x.name}')" style="color:red">åˆ </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        async function act(a, t) {
            if(!confirm('ç¡®å®šæ“ä½œ?')) return;
            const u = localStorage.getItem('u'), p = localStorage.getItem('p');
            await fetch('/api/admin', {
                method: 'POST', headers: { 'X-Admin-Name': u, 'X-Admin-Pass': p },
                body: JSON.stringify({ action: a, targetUser: t, duration: 24 })
            });
            loadAdmin();
        }

        // --- æ‚é¡¹å·¥å…· ---
        function debounceSave() {
            clearTimeout(timer);
            document.getElementById('status').style.opacity = 1;
            document.getElementById('status').innerText = '...';
            timer = setTimeout(() => save(true), 1000);
        }
        
        function fill(d) {
            if(!d) return;
            if(d.name) document.getElementById('name').innerText = d.name;
            if(d.role) document.getElementById('role').innerText = d.role;
            if(d.av) document.getElementById('av').src = d.av;
            if(d.t1) document.getElementById('t1').innerText = d.t1;
            if(d.i1) document.getElementById('i1').className = d.i1;
            // ...ä»¥æ­¤ç±»æ¨
        }

        // ç®€åŒ– DOM æ“ä½œ
        const id = x => document.getElementById(x);
        const text = x => id(x).innerText;
        const src = x => id(x).src;
        const cls = x => id(x).className;
        const val = x => id(x).value;
        
        function checkLog() {
            const isLog = localStorage.getItem('login') === '1';
            const u = localStorage.getItem('u');
            id('btn-login').style.display = isLog ? 'none' : 'flex';
            id('btn-out').style.display = isLog ? 'flex' : 'none';
            id('btn-share').style.display = isLog ? 'flex' : 'none';
            if(isLog && u === ADMIN_NAME) id('btn-admin').style.display = 'flex';
        }

        function clickAv() { if(canEdit()) id('file').click(); }
        function uploadImg(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    c.width = 400; c.height = 400;
                    const ctx = c.getContext('2d');
                    let sx, sy, sw, sh;
                    if(img.width > img.height) { sh=img.height; sw=img.height; sx=(img.width-img.height)/2; sy=0; }
                    else { sw=img.width; sh=img.width; sx=0; sy=(img.height-img.width)/2; }
                    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, 400, 400);
                    id('av').src = c.toDataURL('image/jpeg', 0.8);
                    save(true);
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(f);
        }

        function ic(el) { 
            if(!canEdit()) return; 
            const n = prompt("å›¾æ ‡ä»£ç ", el.className); 
            if(n) { el.className = n; save(true); } 
        }
        
        function canEdit() { return !document.body.classList.contains('read') && localStorage.getItem('login') === '1'; }
        function openM() { id('modal').style.display = 'flex'; }
        function closeM() { id('modal').style.display = 'none'; }
        function flip() { isReg = !isReg; id('m-title').innerText = isReg ? "æ³¨å†Œ" : "ç™»å½•"; id('m-tip').innerText = isReg ? "å»ç™»å½•" : "å»æ³¨å†Œ"; }
        function logout() { localStorage.clear(); location.href = "/"; }
        function mode() { document.body.classList.toggle('dark'); }
        function goHome() { location.href = "/"; }
        function share() { 
            const u = localStorage.getItem('u'); 
            const url = location.origin + '/' + u;
            navigator.clipboard.writeText(url).then(()=>toast('å·²å¤åˆ¶')).catch(()=>prompt("å¤åˆ¶:", url)); 
        }
        function toggleAdmin(s) { id('admin').style.display = s ? 'flex' : 'none'; }
        function toast(t) { 
            const el = document.getElementById('toast'); 
            el.innerText = t; el.style.opacity = 1; el.style.top = "50px";
            setTimeout(() => { el.style.opacity = 0; el.style.top = "30px"; }, 2000); 
        }
        function showStatus(t) { 
            const s = document.getElementById('status'); 
            s.innerText = t; s.style.opacity = 1; 
            setTimeout(() => { s.style.opacity = 0; }, 2000);
        }
    </script>
</body>
</html>
