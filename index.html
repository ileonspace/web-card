<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>æˆ‘çš„æ™ºèƒ½ä¸»é¡µ</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* --- åŸºç¡€è®¾ç½® --- */
        :root { --bg: #EAF3F7; --card: #fff; --text: #334155; --sub: #64748b; --accent: #3a7bd5; --danger: #ff4757; }
        body.dark { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --sub: #94a3b8; }
        body { background: var(--bg); font-family: system-ui, -apple-system, sans-serif; color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; transition: 0.5s; }
        
        /* --- åŠ è½½é®ç½© (è§£å†³é»˜è®¤ç•Œé¢é—ªçƒé—®é¢˜) --- */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        
        /* --- å·¥å…·æ  --- */
        .toolbar, .visitor-nav { position: absolute; top: 20px; z-index: 100; display: flex; gap: 10px; }
        .toolbar { right: 20px; } .visitor-nav { left: 20px; display: none; }
        .btn { background: rgba(255,255,255,0.2); border: 1px solid #cbd5e1; color: var(--text); padding: 8px 15px; border-radius: 20px; cursor: pointer; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 5px; font-size: 13px; transition: 0.3s; white-space: nowrap;}
        .btn:hover { background: rgba(255,255,255,0.6); transform: translateY(-2px); }
        body.dark .btn { border-color: #475569; background: rgba(255,255,255,0.1); }
        .btn-red { color: var(--danger); border-color: var(--danger); } 
        .btn-red:hover { background: var(--danger); color: #fff; }
        .btn-admin { border-color: #8e44ad; color: #8e44ad; } 
        .btn-admin:hover { background: #8e44ad !important; color: white !important; }

        /* --- å¡ç‰‡ä¸»ä½“ --- */
        .card { background: var(--card); width: 100%; max-width: 340px; padding: 40px 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.08); position: relative; }
        .avatar { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 4px solid var(--card); box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 15px; cursor: pointer; transition: 0.5s; }
        .avatar:hover { transform: rotate(360deg); }
        
        [contenteditable="true"]:focus { outline: none; border-bottom: 2px solid var(--accent); background: rgba(58,123,213,0.05); }
        h1 { margin: 10px 0; font-size: 24px; } .role { color: var(--sub); font-size: 13px; margin-bottom: 30px; }
        .list { text-align: left; }
        .item { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; border-radius: 12px; }
        body:not(.read) .item:hover { background: rgba(0,0,0,0.03); }
        .item i { font-size: 20px; color: var(--sub); margin-right: 15px; cursor: pointer; }
        .txt { font-size: 14px; flex: 1; outline: none; word-break: break-all; }
        
        /* --- å¼¹çª— --- */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 999; display: none; justify-content: center; align-items: center; }
        .box { background: var(--card); padding: 30px; border-radius: 20px; width: 300px; text-align: center; }
        .inp { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; background: transparent; color: var(--text); }
        .btn-sub { width: 100%; padding: 10px; background: var(--accent); color: #fff; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        
        /* --- ç®¡ç†é¢æ¿ (ç§»åŠ¨ç«¯é€‚é…) --- */
        #admin { position: fixed; inset: 20px; background: var(--card); z-index: 1500; border-radius: 20px; padding: 20px; display: none; flex-direction: column; box-shadow: 0 50px 100px rgba(0,0,0,0.3); }
        /* å…³é”®ä¿®å¤ï¼šå…è®¸è¡¨æ ¼æ¨ªå‘æ»šåŠ¨ */
        .tbl-wrap { flex: 1; overflow: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; color: var(--text); }
        
        /* --- çŠ¶æ€æŒ‡ç¤º --- */
        #status { position: fixed; bottom: 20px; right: 20px; font-size: 12px; color: var(--sub); opacity: 0; transition: 0.3s; pointer-events: none; }
        .toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background: rgba(50,50,50,0.9); color: #fff; padding: 8px 20px; border-radius: 50px; opacity: 0; z-index: 2000; font-size: 13px; pointer-events: none; transition: 0.3s;}
        
        .read .avatar, .read i { pointer-events: none; }
    </style>
</head>
<body>

    <div id="loader">
        <i class="ri-loader-4-line ri-spin" style="font-size:40px; color:var(--accent)"></i>
        <h3 style="margin-top:20px; color:var(--text)">æ­£åœ¨è¯»å–æ•°æ®...</h3>
    </div>

    <div id="toast"></div>
    <div id="status"></div>
    <input type="file" id="file" hidden accept="image/*" onchange="uploadImg(event)">

    <div id="modal"><div class="box"><h3 id="m-title">ç™»å½•</h3><input id="u" class="inp" placeholder="ç”¨æˆ·å"><input id="p" type="password" class="inp" placeholder="å¯†ç "><button class="btn-sub" onclick="auth()">ç¡®å®š</button><div style="margin-top:10px;font-size:12px;cursor:pointer" onclick="flip()" id="m-tip">å»æ³¨å†Œ</div><button onclick="closeM()" style="margin-top:10px;background:none;border:none;color:#999">å…³é—­</button></div></div>

    <div id="admin">
        <div style="display:flex;justify-content:space-between;margin-bottom:10px"><h3 style="margin:0">ç”¨æˆ·ç®¡ç†</h3><button onclick="toggleAdmin(0)" style="background:none;border:none;font-size:20px">&times;</button></div>
        <div class="tbl-wrap"><table id="tbl"><thead><tr><th>ç”¨æˆ·</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="toolbar" id="tb-edit">
        <button class="btn" id="btn-login" onclick="openM()"><i class="ri-user-line"></i> ç™»å½•</button>
        <button class="btn btn-admin" id="btn-admin" onclick="loadAdmin()" style="display:none"><i class="ri-settings-4-line"></i> ç®¡ç†</button>
        <button class="btn btn-red" id="btn-out" onclick="logout()" style="display:none"><i class="ri-logout-box-line"></i> é€€å‡º</button>
        <button class="btn" id="btn-share" onclick="share()" style="display:none"><i class="ri-share-forward-line"></i> é“¾æ¥</button>
        <button class="btn" onclick="mode()"><i class="ri-moon-line"></i></button>
    </div>

    <div class="visitor-nav" id="tb-read">
        <button class="btn" onclick="goHome()"><i class="ri-arrow-left-line"></i> ä¸»é¡µ</button>
        <button class="btn" onclick="mode()"><i class="ri-contrast-line"></i></button>
    </div>

    <div class="card" oninput="debounceSave()">
        <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" class="avatar" id="av" onclick="clickAv()">
        <h1 id="name" contenteditable="true">Code Master</h1>
        <div id="role" class="role" contenteditable="true">å…¨æ ˆå¼€å‘ç»ƒä¹ ç”Ÿ</div>
        <div class="list">
            <div class="item"><i class="ri-global-line" id="i1" onclick="ic(this)"></i><div id="t1" class="txt" contenteditable="true">ä¸ªäººç½‘ç«™</div></div>
            <div class="item"><i class="ri-mail-send-line" id="i2" onclick="ic(this)"></i><div id="t2" class="txt" contenteditable="true">ç”µå­é‚®ç®±</div></div>
            <div class="item"><i class="ri-map-pin-line" id="i3" onclick="ic(this)"></i><div id="t3" class="txt" contenteditable="true">æ‰€åœ¨åŸå¸‚</div></div>
        </div>
    </div>

    <script>
        // âš ï¸ è¯·ç¡®ä¿è¿™é‡Œçš„ 'admin' å’Œä½  Cloudflare ç¯å¢ƒå˜é‡ ADMIN_USER ä¸€è‡´
        const ADMIN_NAME = 'admin'; 
        let isReg = false, timer = null;

        // --- 1. ç¨‹åºå¯åŠ¨ï¼šæœ€å…³é”®çš„è·¯ç”±é€»è¾‘ ---
        window.onload = () => {
            // è§£æ URLï¼šå»æ‰æœ«å°¾æ–œæ ï¼Œå»æ‰å¼€å¤´çš„ /
            let path = window.location.pathname.replace(/\/$/, "").substring(1);
            
            // å¦‚æœ URL é‡Œæœ‰ä¸œè¥¿ï¼ˆä¸”ä¸æ˜¯ index.htmlï¼‰ï¼Œè¯´æ˜æ˜¯è®¿é—®ç”¨æˆ·ä¸»é¡µ
            if (path && path !== 'index.html') {
                loadCloud(decodeURIComponent(path));
            } else {
                // å¦åˆ™æ˜¯ä¸»é¡µï¼Œæ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€
                checkLog();
            }
        };

        // --- 2. äº‘ç«¯åŠ è½½ (è§£å†³é“¾æ¥æ— æ•ˆé—®é¢˜) ---
        async function loadCloud(user) {
            const l = document.getElementById('loader');
            l.style.display = 'flex'; // æ˜¾ç¤ºå…¨å±é®ç½©ï¼Œé˜²æ­¢çœ‹åˆ°é»˜è®¤ç•Œé¢
            
            // åˆ‡æ¢åˆ°è®¿å®¢ UI
            document.getElementById('tb-edit').style.display = 'none';
            document.getElementById('tb-read').style.display = 'flex';
            document.body.classList.add('read');
            document.querySelectorAll('[contenteditable]').forEach(e => e.setAttribute('contenteditable', 'false'));

            try {
                // è¯·æ±‚åç«¯
                const res = await fetch(`/api/user?name=${user}`);
                if (res.ok) {
                    const json = await res.json();
                    
                    // æ£€æŸ¥å°ç¦çŠ¶æ€
                    if(json.status === 'banned') {
                        l.innerHTML = '<h1 style="color:red">ğŸš« è¯¥è´¦å·å·²è¢«å°ç¦</h1>';
                    } else {
                        // å¡«å……æ•°æ®
                        fill(json.data);
                        l.style.display = 'none'; // åŠ è½½æˆåŠŸï¼Œç§»é™¤é®ç½©
                    }
                } else {
                    if(res.status === 404) l.innerHTML = `<h3>ğŸ¤·â€â™‚ï¸ ç”¨æˆ· ${user} ä¸å­˜åœ¨</h3><br><a href="/" style="color:var(--accent)">æˆ‘ä¹Ÿè¦åˆ›å»º</a>`;
                    else l.innerHTML = `<h3>âŒ æœåŠ¡å™¨é”™è¯¯ (${res.status})</h3>`;
                }
            } catch (e) {
                l.innerHTML = `<h3>âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥</h3><p>è¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é‡è¯•</p>`;
            }
        }

        // --- 3. è®¤è¯é€»è¾‘ (ä¿®å¤å¯†ç é”™è¯¯é—®é¢˜) ---
        async function auth() {
            const u = val('u'), p = val('p');
            if(!u || !p) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');
            
            if(isReg) {
                // æ³¨å†Œé€»è¾‘
                // å…ˆæ£€æŸ¥æœ¬åœ°é˜²æ­¢é‡å¤æäº¤
                if(localStorage.getItem('pass_'+u)) return alert('æœ¬åœ°å·²å­˜åœ¨æ­¤ç”¨æˆ·ï¼Œè¯·ç™»å½•');
                
                // å»äº‘ç«¯æ£€æŸ¥æ˜¯å¦å ç”¨
                const check = await fetch(`/api/user?name=${u}`);
                if(check.ok) return alert('ç”¨æˆ·åå·²è¢«å ç”¨ï¼Œè¯·æ¢ä¸€ä¸ª');

                // æœ¬åœ°è®°å½•å¯†ç ï¼Œåˆ‡æ¢åˆ°ç™»å½•
                localStorage.setItem('pass_'+u, p);
                toast('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                flip();
            } else {
                // ç™»å½•é€»è¾‘
                const localPass = localStorage.getItem('pass_' + u);
                
                // æƒ…å†µAï¼šæœ¬åœ°æœ‰å¯†ç ï¼Œç›´æ¥éªŒè¯ (æœ€å¿«)
                if (localPass === p) {
                    success(u, p, null); // null è¡¨ç¤ºæš‚æ—¶ä¸ç”¨äº‘ç«¯æ•°æ®è¦†ç›–ï¼Œç­‰ä¸‹ä¼šè‡ªåŠ¨æ‹‰
                    return;
                }

                // æƒ…å†µBï¼šæœ¬åœ°æ²¡å¯†ç  (æ–°è®¾å¤‡)ï¼Œå»äº‘ç«¯éªŒè¯
                toast('æ­£åœ¨äº‘ç«¯éªŒè¯...');
                try {
                    const res = await fetch(`/api/user?name=${u}`);
                    if(res.ok) {
                        const json = await res.json();
                        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå…¼å®¹æ—§å¯†ç å­—æ®µ _p å’Œæ–°å­—æ®µ _secret_pass
                        const cloudP = json.data ? (json.data._secret_pass || json.data._p) : null;
                        
                        if(cloudP === p) {
                            // ç™»å½•æˆåŠŸï¼ŒåŒæ­¥æ•°æ®åˆ°æœ¬åœ°
                            localStorage.setItem('userData_' + u, JSON.stringify(json.data));
                            success(u, p, json.data);
                        } else { alert('å¯†ç é”™è¯¯'); }
                    } else {
                        alert('ç”¨æˆ·ä¸å­˜åœ¨');
                    }
                } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
            }
        }

        function success(u, p, data) {
            localStorage.setItem('login', '1');
            localStorage.setItem('u', u);
            localStorage.setItem('p', p); // è®°ä½å¯†ç 
            localStorage.setItem('pass_' + u, p); // å¤‡ä»½å¯†ç 
            if(data) fill(data);
            checkLog();
            closeM();
            toast('âœ… æ¬¢è¿å›æ¥');
        }

        // --- 4. ä¿å­˜é€»è¾‘ ---
        async function save(silent = false) {
            if (localStorage.getItem('login') !== '1') return;
            const u = localStorage.getItem('u');
            const p = localStorage.getItem('p'); // è·å–å½“å‰ç™»å½•å¯†ç 
            if(!silent) toast('æ­£åœ¨ä¿å­˜...');
            
            const data = {
                name: text('name'), role: text('role'), av: src('av'),
                t1: text('t1'), i1: cls('i1'),
                t2: text('t2'), i2: cls('i2'),
                t3: text('t3'), i3: cls('i3'),
                _secret_pass: p // ğŸ”¥ ç»Ÿä¸€å­˜ä¸ºè¿™ä¸ªæ–°å­—æ®µ
            };

            showStatus('åŒæ­¥ä¸­...');
            try {
                // å‘é€ç»™åç«¯
                const res = await fetch('/api/user', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: u, password: p, data: data })
                });
                
                if(res.ok) {
                    localStorage.setItem('userData_' + u, JSON.stringify(data));
                    if(!silent) toast('âœ… å·²ä¿å­˜');
                    showStatus('å·²åŒæ­¥');
                } else {
                    showStatus('âŒ ä¿å­˜å¤±è´¥');
                }
            } catch(e) { showStatus('âš ï¸ ç½‘ç»œé”™è¯¯'); }
        }

        // --- 5. ç®¡ç†å‘˜ (ä¿®å¤ç§»åŠ¨ç«¯è¡¨æ ¼) ---
        async function loadAdmin() {
            toggleAdmin(1);
            const t = document.getElementById('tbl').querySelector('tbody');
            t.innerHTML = '<tr><td>åŠ è½½ä¸­...</td></tr>';
            const u = localStorage.getItem('u'), p = localStorage.getItem('p');
            
            // å‘é€ Header éªŒè¯
            const res = await fetch('/api/admin', { headers: { 'X-Admin-Name': u, 'X-Admin-Pass': p } });
            if(res.status===401) return alert('æƒé™éªŒè¯å¤±è´¥ï¼šè¯·æ£€æŸ¥ç¯å¢ƒå˜é‡');
            const list = await res.json();
            
            t.innerHTML = list.map(x => `
                <tr>
                    <td>${x.name} <span style="font-size:10px;color:#999">${x.role||'user'}</span></td>
                    <td>${x.status==='banned'?'ğŸ”´':'ğŸŸ¢'}</td>
                    <td>
                        ${x.name !== u ? `
                        <button onclick="act('ban','${x.name}')" style="color:orange">ç¦</button>
                        <button onclick="act('unban','${x.name}')" style="color:green">è§£</button>
                        <button onclick="act('delete','${x.name}')" style="color:red">åˆ </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        async function act(a, t) {
            if(!confirm('ç¡®å®šæ“ä½œ?')) return;
            const u = localStorage.getItem('u'), p = localStorage.getItem('p');
            await fetch('/api/admin', {
                method: 'POST', headers: { 'X-Admin-Name': u, 'X-Admin-Pass': p },
                body: JSON.stringify({ action: a, targetUser: t, duration: 24 })
            });
            loadAdmin(); // åˆ·æ–°åˆ—è¡¨
        }

        // --- å·¥å…·å‡½æ•° ---
        function debounceSave() {
            clearTimeout(timer);
            document.getElementById('status').style.opacity = 1;
            document.getElementById('status').innerText = 'ä¿®æ”¹ä¸­...';
            timer = setTimeout(() => save(true), 1500); // 1.5ç§’åè‡ªåŠ¨ä¿å­˜
        }
        
        function fill(d) {
            if(!d) return;
            if(d.name) document.getElementById('name').innerText = d.name;
            if(d.role) document.getElementById('role').innerText = d.role;
            if(d.av) document.getElementById('av').src = d.av;
            if(d.t1) document.getElementById('t1').innerText = d.t1;
            if(d.i1) document.getElementById('i1').className = d.i1;
            if(d.t2) document.getElementById('t2').innerText = d.t2;
            if(d.i2) document.getElementById('i2').className = d.i2;
            if(d.t3) document.getElementById('t3').innerText = d.t3;
            if(d.i3) document.getElementById('i3').className = d.i3;
        }

        const id = x => document.getElementById(x);
        const text = x => id(x).innerText;
        const src = x => id(x).src;
        const cls = x => id(x).className;
        const val = x => id(x).value;
        
        function checkLog() {
            const isLog = localStorage.getItem('login') === '1';
            const u = localStorage.getItem('u');
            id('btn-login').style.display = isLog ? 'none' : 'flex';
            id('btn-out').style.display = isLog ? 'flex' : 'none';
            id('btn-share').style.display = isLog ? 'flex' : 'none';
            // æ˜¾ç¤ºç®¡ç†æŒ‰é’®
            if(isLog && u === ADMIN_NAME) id('btn-admin').style.display = 'flex';
            
            // å°è¯•åŠ è½½æœ¬åœ°ç¼“å­˜æ•°æ®ï¼Œé˜²æ­¢ç™½å±
            if(isLog) {
                const cache = localStorage.getItem('userData_' + u);
                if(cache) fill(JSON.parse(cache));
            }
        }

        function clickAv() { if(canEdit()) id('file').click(); }
        function uploadImg(e) {
            const f = e.target.files[0]; if(!f) return;
            toast('å¤„ç†ä¸­...');
            const r = new FileReader();
            r.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    c.width = 400; c.height = 400;
                    const ctx = c.getContext('2d');
                    let sx, sy, sw, sh;
                    if(img.width > img.height) { sh=img.height; sw=img.height; sx=(img.width-img.height)/2; sy=0; }
                    else { sw=img.width; sh=img.width; sx=0; sy=(img.height-img.width)/2; }
                    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, 400, 400);
                    id('av').src = c.toDataURL('image/jpeg', 0.8);
                    save(true);
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(f);
        }

        function ic(el) { 
            if(!canEdit()) return; 
            const n = prompt("è¾“å…¥ RemixIcon ä»£ç  (å¦‚ ri-wechat-line)", el.className); 
            if(n) { el.className = n; save(true); } 
        }
        
        function canEdit() { return !document.body.classList.contains('read') && localStorage.getItem('login') === '1'; }
        function openM() { id('modal').style.display = 'flex'; }
        function closeM() { id('modal').style.display = 'none'; }
        function flip() { isReg = !isReg; id('m-title').innerText = isReg ? "æ³¨å†Œ" : "ç™»å½•"; id('m-tip').innerText = isReg ? "å»ç™»å½•" : "å»æ³¨å†Œ"; }
        function logout() { localStorage.setItem('login', '0'); localStorage.removeItem('u'); location.href = "/"; }
        function mode() { document.body.classList.toggle('dark'); }
        function goHome() { location.href = "/"; }
        function share() { 
            const u = localStorage.getItem('u'); 
            const url = location.origin + '/' + u;
            navigator.clipboard.writeText(url).then(()=>toast('å·²å¤åˆ¶')).catch(()=>prompt("å¤åˆ¶:", url)); 
        }
        function toggleAdmin(s) { id('admin').style.display = s ? 'flex' : 'none'; }
        function toast(t) { const el = document.getElementById('toast'); el.innerText = t; el.style.opacity = 1; el.style.top = "50px"; setTimeout(() => { el.style.opacity = 0; el.style.top = "30px"; }, 2000); }
        function showStatus(t) { const s = document.getElementById('status'); s.innerText = t; s.style.opacity = 1; setTimeout(() => { s.style.opacity = 0; }, 2000); }
    </script>
</body>
</html>
